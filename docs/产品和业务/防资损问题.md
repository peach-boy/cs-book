# 支付系统之资损问题



### 一、网络异常问题
* when
>即在调用支付系统或第三方支付系统时，由于网络原因(如超时等原因)导致出现类似于connection confused,time out异常
* how
>此时发生的异常，为网络异常，无法得知支付系统的真实状态(有可能已完成支付流程，但网络抖动，调用端没收到响应)，此时应将支付单状态置为中间状态，如：支付中状态。等待定时器查询该支付单在支付系统的实际状态，从而更新支付单状态。如果此时将支付单状态置为失败，有可能会发生重复支付的风险，从而导致资损。


### 二、查询和通知问题
支付系统通常包括：支付接口，状态查询接口，异步通知。
* 其中当调用查询接口查询支付单状态时，需要特别区分是查询操作本身失败，还是当前支付单支付失败，如果是前者可再次重试，不可将调用失败当成查询结果为失败。
* 主动查询可以不同的时间间隔重试多次，支付系统处理链路较长，可能出现第一次查询时，状态还在处理中。

### 三、接口幂等问题
* 查询接口：同一笔订单查询接国药始终一致
* 支付接口：以上游传入的支付单号或订单号做唯一标识，入口处redis缓存防重或数据库唯一键保证防重复支付

### 四、状态同步问题
* when
>上下游系统间的状态同步，出现重复通知，或前后通知结果不一致
* how
>应用有限状态机（FSM），在更新状态时，采用update payOrder set status=success where id=1 and status=paying。校验更新条数不为1即为异常。尤其在定时任务，mq等可能存在重复执行的场景。

### 五、重复支付问题
* 并发重复支付
    * when
    >集群部署不同节点接收到同一个单号的不同的支付请求
    * how
    >以支付单号或订单号做唯一标识，使用redis缓存或数据库唯一键保证防重复支付

* 定时器重复执行
    * 定时任务重复执行，任务需根据状态指定状态才执行操作。

* 表单重复提交
    * when
    >用户重复提交
    * how
    >app端支付验证通过后跳转到新页面，新页面禁用返回按钮。网页端同样跳转到新页面，同时旧页面展示弹出层，阻止用户再次点击付款(参见当当网)
* mq重复通知
    * mq消息重新入队后，消费端需做好幂等处理

### 六、监控与对账
* 当发生特定异常触发报警，人工干预
* 单据和账目对账，及时发现资金损失


    数据库乐观锁 有限状态机 白名单



 

