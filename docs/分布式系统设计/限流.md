# 限流

## 一、为什么需要限流

我们系统各种资源（计算资源，存储资源等灯）是有限的，如果系统受到大于当前资源可承受最大限度的请求量时，就可能导致系统崩溃。所以限流的目的就是利用一些算法将大流量的请求，“瘦身”成当前计算资源可承受的流量级别，以达到保护系统的目的。

## 二、获得系统能力的上限

对需要做限流的模块或服务做压力测试，以获取系统能承受的请求数。

## 二、在哪里限流

### 1、网关层限流

> 入口网关可以针对域名或 IP 进行粗放式限流，静态资源直接走 CDN（内容分发网络），同时在这一层还可以将一些不合法的请求拦截掉，不要流入下游，仅放过合法请求。

### 2、应用层限流

> 到了应用服务层，每个服务可以有自己的单机或集群限流，调用第三方服务时，也可以单独进行限流.或者单独对某些接口做限流

## 三、限流策略

1. 服务拒绝
   > 当请求流量达到限流阈值时，对多余的请求直接拒绝。 可通过设计实现对指定域名、IP、客户端、应用、用户等不同来源的请求进行拒绝。
2. 延时处理
   > 通过将多余的请求加入缓存队列或延时队列，来应对短期的流量突增，高峰期过后开始将堆积的请求流量逐渐处理。
3. 请求分级（优先级）
   > 对不同来源的请求设置优先级，先处理优先级更高的请求。如 VIP 客户、重要的业务应用（如交易服务优先级高于日志服务）
4. 动态限流
   > 可以监控系统相关指标、评估系统压力，通过注册中心、配置中心等动态调整限流阈值。
5. 监控预警&动态扩容
   > 如果有优秀的服务监控系统与自动部署、发布系统，可以通过监控系统自动监测系统运行情况，对短期内服务压力暴增、流量大幅写入的情况进行邮件、短信等方式进行预警。

## 四、限流算法

### 1、固定窗口

- 概念：在单位时间内，统计进入的请求数量，统计值达到限流阈值时，开始限流（如拒绝和排队）。这个单位时间结束后，计算器清零，重新开始计数。

### 2、滑动窗口

- 概念：滑动窗口对固定窗口进行改良，将其细化，将一个时间窗口划分为若干个时间窗格，每个窗格代表固定的时间段（如 1 分钟）、拥有独立的计数器，每过固定时间（如 1 分钟），将滑动窗口向前移动一格。滑动窗口中的窗格划分越细，限流统计越精确。

### 3、漏桶算法

### 4、令牌桶算法

- 概念：以恒定速率（令牌产生速率）向令牌桶中放入令牌，令牌桶满（令牌桶大小）则无法放入。请求到达后先获取令牌，拿到令牌后请求被处理并删除获得的令牌。令牌不足时，请求无法获得令牌，请求被拒绝。

### 五、实践

1. nginx
2. Hystrix 或 Resilience4j
3. Sentinel
4. Guava Ratelimiter
5. Redis

参考来源

- [容量治理的三板斧：扩容、限流与降级](https://time.geekbang.org/column/article/375295)
- [高可用之限流](https://houbb.github.io/2018/12/23/ha-limit-01-basic)
